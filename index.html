<!DOCTYPE html>
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf8">
<meta name="author" content="Tobi Turing">
<meta id="vers" name="version" content="0.4">
<meta id="date" name="date" content="2015-02-23">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="keywords" content="Cellular, Automata, Wave, Generator, Greenberg-Hastings Cellular Automaton">
<title class="item">Wave Generator</title>
<meta http-equiv="Content-Style-Type" content="text/css">
<link href="wave.css" title="wave" rel="stylesheet" type="text/css">
<link href="pix.css" title="pixelove" rel="alternate stylesheet" type="text/css">
<script src='ext/jquery-2.0.3.js'></script>
<script src='ext/underscore.js'></script>
<script src='settings.js'></script>
</head>
<body>
<span id="style" class="main"></span>
<div class="main">
<div id="logo">
    <h2 id="logo_titel" class="unselectable">Wave Generator</h2>
</div>
<div id="canvas_container">
    <div id="hover_text" class="main">
    Click here
    </div>
    <canvas id="c" class="main">
    </canvas>
</div>
<form>
<button id="reset_button" class="controls" type="button">reset</button>
<button id="start_button" class="controls" type="button">start</button>
<button id="next_cycle_button" class="controls" type="button">next</button>
<button id="save_button" class="state" type="button">save</button>
<button id="load_button" class="state" type="button">load</button>
<button id="export_button" class="state" type="button">export</button>
<button id="toimage_button" type="button" style="display:none">2image</button>
<select id="detail_select" class="controls" type="list" list="detail_list"></select>
<label id="detail_label" class="controls" for="detail_select">level of detail</label>
<select id="algo_select" class="controls" type="list" list="algo_list"></select>
<label id="algo_label" class="controls" for="algo_select">algorithm</label>
<select id="nb_select" class="controls" type="list" list="neighborhood_list"></select>
<label id="nb_label" class="controls" for="nb_select">neighborhood</label>
<select id="nb_r_select" class="controls" type="list" list="neighborhood_r_list"></select>
<label id="nb_r_label" class="controls" for="nb_r_select">radius</label>
<select id="state_select" class="controls" type="list" list="state"></select>
<label id="state_label" class="controls" for="state_select">state</label>
</form>
</div>
<div id='debug_info'>
    <table border="1">
    <tr><th>info:</th></tr>
    <tr><td>cycle</td><td><span id='cycle'>&nbsp;</span></td></tr>
    <tr><td>speed</td><td><span id='speed'>&nbsp;</span></td></tr>
    <tr><td>mouse</td><td><span id='mouse_pos'>&nbsp;</span></td></tr>
    <tr><td>grid</td><td><span id='grid_pos'>&nbsp;</span></td></tr>
    </table>  
</div>
<div id='footer' class='main'>
  <a href="http://en.wikipedia.org/wiki/Greenberg-Hastings_cellular_automaton">
  Info</a>, author: 
  <a href="http://dev.fet.li">Tobi Turing</a>
</div>
<script src='algo.js'></script>
<script src='grid.js'></script>
<script src='view.js'></script>
<script src='pattern.js'></script>
<script src='seq.js'></script>
<script src='tick.js'></script>
<script type='text/javascript'>

"use strict";

//global vars
var $, c, cycle, clock_state, grid, grid_main, js, log_matrix, matrix,
next_cycle, pixel, parse_url, reset_canvas, seq, settings, set_grid, start_clock,
stop_clock, algorithms, pattern, state;

var karel = false;

var url_string = parse_url();
if (typeof(url_string.debug) !== 'undefined') { 
    settings.debug = (url_string.debug === 'true'); 
}
if (typeof(url_string.karel) !== 'undefined') { 
    karel = (url_string.karel === 'true'); 
}

function append_options(id, num, default_value) {
    var select = document.getElementById(id);
    var options = [];
    for (var n = 1; n <= num; n++) {
        options[n] = document.createElement('option');
        if (n === default_value) { 
            options[n].setAttribute('selected', true); 
        }
        options[n].innerHTML = n;
        select.appendChild(options[n]);
    }
}

function append_options_algo(id, algorithms, default_value) {
    var select = document.getElementById(id);
    var options = [];
    _.each(algorithms, function(num, key) {
        options[num] = document.createElement('option');
        if (num === default_value) {
            options[num].setAttribute('selected', true);
        }
        options[num].innerHTML = num;
        select.appendChild(options[num]);
    });
}

function append_options_nb(id, algorithms, default_value) {
    var select = document.getElementById(id);
    $('#' + id).children().remove();
    var options = [];

    var n = _.keys(algorithms.neighborhood);
    _.each(n, function(num, key) {
        options[num] = document.createElement('option');
        if (num === default_value) { 
            options[num].setAttribute('selected', true); 
        }
        options[num].innerHTML = num;
        select.appendChild(options[num]);
    });
}

function append_options_nb_r(id, neighborhood, default_value) {
    var select = document.getElementById(id);
    $('#' + id).children().remove();
    var options = [];
    for (var n = 1; n <= algorithms[settings.algorithm].neighborhood[neighborhood].radius.length; n++) {
        options[n] = document.createElement('option');
        if (n === default_value) { 
            options[n].setAttribute('selected', true); 
        }
        options[n].innerHTML = n;
        select.appendChild(options[n]);
    }
}

function append_options_state(id, state, default_value){
	console.log('append_options_state');
	console.log(settings.state);
	console.log(state);
    var select = document.getElementById(id);
    $('#' + id).children().remove();
    var options = [];
	var n = _.keys(state.colors);
	console.log(n);
    _.each(n, function(num, key) {
		console.log(num)
        options[num] = document.createElement('option');
        if (num === default_value) { 
            options[num].setAttribute('selected', true); 
        }
        options[num].innerHTML = num;
        select.appendChild(options[num]);
    });
}

function press_start_stop_button(b, speed) {
    if (!clock_state) {
        b.innerHTML = 'stop';
        start_clock(speed);
        $('#save_button').attr("disabled", true);
        $('#next_cycle_button').attr("disabled", true);
    } else {
        b.innerHTML = 'start';
        stop_clock();
        $('#save_button').attr("disabled", false);
        $('#next_cycle_button').attr("disabled", false);
    }
}

function enable_control_buttons() {
    $('#next_cycle_button').click(function (e) { 
        next_cycle();
    });
    $('#start_button').click(function (e) { 
        press_start_stop_button(this, settings.speed);
    });
    $('#reset_button').click(function (e) { 
        stop_clock(); 
        reset_canvas();
        $('#start_button').html('start');
        //pattern.line();
    });
    $('.controls').attr("disabled", false);
}

$('#detail_select').change(function () {
    reset_canvas();
    $('#load_button').attr("disabled", true);
});

$('#nb_select').change(function () {
    settings.algorithms[settings.algorithm].neighborhood.type = $(this).val();
    append_options_nb_r('nb_r_select', $(this).val(), 1);
});

$('#nb_r_select').change(function () {
    settings.algorithms[settings.algorithm].neighborhood.r = parseInt($(this).val(), 10);
});

$('#algo_select').change(function (){
	console.log("THIS:");
	console.log($(this));
    settings.algorithm = $(this).val();
    append_options_nb('nb_select', algorithms[settings.algorithm]);
});

$('#state_select').change(function (){
	settings.state = $(this).val();
	console.log('settings.state');
	console.log(settings.state);
	append_options_state('state_select', state);
	update_steps()
});

$('#save_button').click(function (e) {
    if (settings.verbose) {
        log_matrix(matrix.data);
    }
    settings.save = JSON.stringify(matrix);
    console.log('cookie saved', settings.save);
    $('#load_button').attr("disabled", false);
});

$('#load_button').click(function (e) {
    if (settings.verbose) {
        log_matrix(matrix.data);
    }
    set_grid(JSON.parse(settings.save));
});

$('#export_button').click(function (e) {
    var m = JSON.stringify(matrix);
    var generator = window.open('', 'name', 'height=400,width=500');
    generator.document.write(JSON.stringify(matrix));
    generator.document.close();
});

$('#toimage_button').click(function (e) {
    var URL;
    var canvas = document.getElementById("c");
    canvas.toBlob(function (blob) {
        var newImg = document.createElement("img"),
        url = URL.createObjectURL(blob);
        newImg.onload = function () {
            // no longer need to read the blob so it's revoked
            URL.revokeObjectURL(url);
        };
        newImg.src = url;
        document.body.appendChild(newImg);
    });
});

function set_touched_state() {
    settings.touched = true;
    $('#save_button').attr("disabled", false);
    $('#export_button').attr("disabled", false);
    $('#hover_text').hide();
    $('.controls').attr("disabled", false);
}

function set_untouched_state() {
    settings.touched = false;
    $('#save_button').attr("disabled", true);
    $('#export_button').attr("disabled", true);
    $('#hover_text').show();
    $('.controls').attr("disabled", true);
}

$('canvas').click(function (e) {
    if (!settings.touched && settings.ready) {
        set_touched_state();
        $('canvas').css({"border-width": "1px"});
    }
    var x = e.pageX - this.offsetLeft;
    var y = e.pageY - this.offsetTop;
    $('#mouse_pos').html(x + ', ' + y);
    var g_x = Math.floor(x / grid.pixel);
    var g_y = Math.floor(y / grid.pixel);
    pixel(g_x, g_y);
    $('#grid_pos').html(g_x + ', ' + g_y);
    log_matrix(matrix.data);
});

function show_interaction_text() {
    $('#hover_text').show();
}

function set_ready() {
    settings.ready = true;
}

function main() {
    enable_control_buttons();
    $('#vers').attr("content", settings.version);
    $('#date').attr("content", settings.date);
    $('#hover_text').hide();
    $('#debug_info').hide();
    $('.state').attr("disabled", true);
    $('.controls').attr("disabled", true);
    if (settings.debug === true) {
        $('#debug_info').show();
    } 
    append_options('detail_select', settings.detail.max, settings.detail.initial);
    append_options_nb('nb_select', algorithms[settings.algorithm], settings.algorithm);
    append_options_nb_r('nb_r_select', 'random', settings.algorithms[settings.algorithm].neighborhood.r);
    append_options_algo('algo_select', _.keys(settings.algorithms), settings.algorithm);
    append_options_state('state_select', state, settings.state);
    grid_main();
    $('.unselectable').on('selectstart dragstart', 
    function (evt) {
        evt.preventDefault();
        return false; 
    });
    if (settings.intro) { 
        seq.intro();
    } else {
        settings.ready = true;
    }
}

$(document).ready(function () {
    main();
    
});
</script>
</body></html>
