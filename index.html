<!DOCTYPE html>
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf8">
<meta name="author" content="Tobi Turing">
<meta name="version" content="0.2.2">
<meta name="date" content="2013-09-17">
<meta name="keywords" content="Cellular, Automata, Wave, Generator, Greenberg-Hastings Cellular Automaton">
<title class="item">Cellular Automaton - Wave Generator</title>
<script src='jquery-2.0.3.js'></script>
<!-- http://en.wikipedia.org/wiki/Greenberg-Hastings_cellular_automaton -->
</head>
<body style="font-family:helvetica;">
<div>
<canvas id="c" style="border:1px dotted;float:left;" ></canvas>
<h2>Wave Generator</h2>
<form>
<button id="next_cycle_button" type="button">next cycle</button>
<button id="start_button" type="button">start</button>
<button id="stop_button" type="button">stop</button>
<button id="reset_button" type="button">reset grid</button>
<br/>
<div id='functions_div'>
<p>functions:</p>
<button id="checkerboard_button" type="button">draw checkerboard</button>
</div>
<br/>
<select id="detail_select" type="list" list="detail_list">
</select>
<label for="detail_select">level of detail</label>
</form>
</div>
<div id='debug_info'>
<table border="1">
<tr><th>info:</th></tr>
<tr><td>cycle</td><td><span id='cycle'>&nbsp;</span></td></tr>
<tr><td>speed</td><td><span id='speed'>&nbsp;</span></td></tr>
<tr><td>mouse</td><td><span id='mouse_pos'>&nbsp;</span></td></tr>
<tr><td>grid</td><td><span id='grid_pos'>&nbsp;</span></td></tr>
</table>  
</div>
<br/>
click on / touch the blue canvas to start!
<script src='grid.js'></script>
<script src='draw.js'></script>
<script type='text/javascript'>

"use strict";

function toScope(ids) {
  var a = [];
  if(typeof(ids) !== undefined) { 
    for(var n=0; n<ids.length; n++){
      a[ids[n]] = document.getElementById(ids[n]);
    }
  }
  return a;
}

// DOM Elements
var buttons = toScope(['next_cycle_button', 'start_button', 'stop_button', 'checkerboard_button', 'reset_button']);
var selects = toScope(['detail_select']);
//variables from grid.js
var matrix;
var grid;
var cycle;
var c;
//functions from grid.js
var update_cycleview;
var log_matrix;
var pixel;
var init_grid;
var checkerboard;
var grid_main;
var parse_url;
//functions from draw.js
var draw_heart;
var draw_t_k;
var draw_logo;

/* ****** */
var debug=false;
var karel=false;

var url_string = parse_url();
if(typeof(url_string.debug) !== 'undefined') { 
  debug = (url_string.debug === 'true'); 
}
if(typeof(url_string.karel) !== 'undefined') { 
  karel = (url_string.karel === 'true'); 
}


function next_cycle(){
  var verbose = false;
  update_cycleview(++cycle);
  var size = matrix.size;
  log_matrix(matrix.data);
  var last_matrix = [];
  if(debug) { console.log(matrix); }
  var x,y;
  for(x=0; x<size; x++){
      last_matrix.push(matrix.data[x].slice());
  }
  for(y=0; y<size; y++){  
    for(x=0; x<size; x++){
      var x_left = (x-1<0) && size-1 || x-1;
      var x_right = (x+1)%(size);
      var y_top = (y-1<0) && size-1 || y-1;
      var y_bottom = (y+1)%(size);
      var left = parseInt(last_matrix[x_left][y], 10);
      var right = parseInt(last_matrix[x_right][y], 10);
      var top = parseInt(last_matrix[x][y_top], 10);
      var bottom = parseInt(last_matrix[x][y_bottom], 10);
      var result;
      //rule 1 and 2
      if(last_matrix[x][y] === 1 || last_matrix[x][y] === 2) { 
        pixel(x,y);
        if(verbose) { result = (last_matrix[x][y] + 1 )%3; }
      } else if(last_matrix[x][y] === 0) { //rule 3
        if(left === 1 || right === 1 || top === 1 || bottom === 1) {
          pixel(x,y);
          if(verbose) { result = (last_matrix[x][y] + 1 )%3; }
        } else if(left === 0 && right === 0 && top === 0 && bottom === 0){
          // do nothing
          if(verbose) { result = (last_matrix[x][y] )%3; }
        } else { if(verbose) { result = (last_matrix[x][y] )%3; } }
      }
      if(verbose){
        console.log('['+x+']['+y+']');
        console.log('  '+top);
        console.log(left+' '+last_matrix[x][y]+' '+right+'  => '+result);
        console.log('  '+bottom);
      }
    }
  }
  log_matrix(last_matrix);
  log_matrix(matrix.data);
}

function reset_canvas(){
  c.canvas.width++;
  c.canvas.width--;
  init_grid();
  cycle = 0;
  update_cycleview(cycle);
}

function append_options(id, num, default_value){
    var select = document.getElementById(id);
    var options = [];
    for( var n = 1; n <= num; n++){
      options[n] = document.createElement('option');
      if ( n === default_value ) {  options[n].setAttribute('selected',true); }
      options[n].innerHTML=n;
      select.appendChild(options[n]);
    }
}

var clock;
var clock_state = false;
var speed = 125; //interval time in ms

function start_clock(speed){
    function start(){
        next_cycle();  
        if(debug) { console.log('cycling..'+cycle+'. iteration'); }
    }
      
    if ( !clock_state ) {
      clock_state = true;
      clock = window.setInterval(start,speed);
    }
}

function stop_clock(){
    clearInterval(clock);
    console.log('stopping auto cycle');
    clock_state = false;
}

function intro(){
  var r = Math.floor(Math.random()*100);
  if( karel ) {
    window.setTimeout(draw_heart,10);
    window.setTimeout(draw_heart,2000);
    window.setTimeout(draw_heart,2100);
    window.setTimeout(draw_heart,2150);
    window.setTimeout(draw_t_k,2050);
    window.setTimeout(draw_t_k,2150);
    window.setTimeout(start_clock,2300);
    window.setTimeout(stop_clock,2499);
    window.setTimeout(reset_canvas,2500);
  } else {
    pixel(0,0);
    start_clock(60);
    window.setTimeout(stop_clock,2000);
    window.setTimeout(draw_logo,2200,0,3);
    if( r > 90 || r < 10 ) {
      window.setTimeout(draw_logo,2100,1,0);
      window.setTimeout(draw_logo,2400,1,0);
    }
    if( r > 75 ) { //long intro
      window.setTimeout(pixel,2700,8,8);
      window.setTimeout(pixel,2900,8,8);
      window.setTimeout(start_clock,3000,125);
      window.setTimeout(stop_clock,3500);
      window.setTimeout(pixel,3750,8,8);
      window.setTimeout(start_clock,4000,50);
      window.setTimeout(stop_clock,4950);
      window.setTimeout(reset_canvas,5000);
    } else { //short intro
      window.setTimeout(start_clock,3000,75);
      window.setTimeout(stop_clock,3500);
      window.setTimeout(reset_canvas,3501);
    }
  }
  console.log(r);
}

function main(){
  $('#functions_div').hide();
  $('#debug_info').hide();
  console.log(debug);
  if(debug === true) {
    $('#debug_info').show();
  } 
  append_options('detail_select', 8, 4);
  grid_main();
  intro();
}

buttons.next_cycle_button.onclick = function() { next_cycle(); };
buttons.start_button.onclick = function() { start_clock(speed); };
buttons.stop_button.onclick = function() { stop_clock(); };
buttons.checkerboard_button.onclick = function() { checkerboard(); };
buttons.reset_button.onclick = function() { stop_clock(); reset_canvas(); };
selects.detail_select.onchange= function() { reset_canvas(); };

$('canvas').click(function(e){
  var x = e.pageX - this.offsetLeft;
  var y = e.pageY - this.offsetTop;
  $('#mouse_pos').html(x + ', ' + y);
  var g_x = Math.floor( x / grid.pixel );
  var g_y = Math.floor( y / grid.pixel );
  pixel(g_x,g_y);
  $('#grid_pos').html(g_x + ', ' + g_y);
  log_matrix(matrix.data);
});

main();
</script>
</body></html>
